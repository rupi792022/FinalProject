<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <link href="../css/Guiding.css" rel="stylesheet" />
    <title></title>
    <script>
        $(document).ready(function () {
            getDatails = JSON.parse(localStorage.getItem('VolunteerDetails'));
            var user = $('<a class= "dropdown-toggle" data-toggle="dropdown" href="#">' + getDatails.First_name.toUpperCase() + ' ' + getDatails.Last_name.toUpperCase() + '<span class= "caret"></span></a><ul class="dropdown-menu"><li><a href="#">Personal details</a></li><li><a onclick="logOut()">Log out</a></li></ul>');
            $(user).clone().appendTo(".dropdown");

            let apiCall = "../api/GuidingPrograms/Read_GP";
            ajaxCall("GET", apiCall, "", getSuccessGP, getErrorGP);

            $(document).on("click", ".btnLevel", startLevel);
            $(document).on("click", "#uploadRender", uploadRender);
            $(document).on("click", "#checkAnswer", checkAnswer);
            $(document).on("click", "#nextUpload", nextUpload);
            $(document).on("click", "#createQuestion", createQuestion);
            $(document).on("click", "#nextAnswer", renderQuestions);
            score = 0;
        });

        function logOut() {
            localStorage.clear();
            window.location.href = "LogIn.html";
        }
      
        function getSuccessGP(gp) {
            console.log("Success GP")
            GP = gp; //All the Guiding Programs
            performs();
        }

        function performs() {
        let apiCall = "../api/PerformsPrograms/Read_maxLevelsPerforms?email=" + getDatails.Volunteer_email;
            ajaxCall("GET", apiCall, "", getSuccessMaxLevelsP, getErrorMaxLevelsP);
        }
        
        function renderLevels() {
            str = "";
            for (var i = 0; i < GP.length; i++) {
                if ((i + 1) <= themaxlevel) {
                    str += '<button type="button" style="background:green" class="btnLevel" disabled id="' + (i + 1) + '"> Level ' + (i + 1) + '</button >&nbsp;&nbsp;&nbsp;';
                }
                else str += '<button type="button" class="btnLevel" id="' + (i + 1) + '"> Level ' + (i + 1) + '</button >&nbsp;&nbsp;&nbsp;';
            }
            document.getElementById("learning").innerHTML = str;
            
        }

        function getErrorGP() {
            console.log("the GP is not read");
        }

        function getSuccessMaxLevelsP(maxlevels) {
            themaxlevel = maxlevels; 
            renderLevels();
        }
        function getErrorMaxLevelsP() {
            console.log("the MaxLevelsP is not read");
        }


        function startLevel() {
            levelNum = $(this).attr("id");
            str = "";
            str += '<p>' + GP[levelNum - 1].Content_level + '</p>';
            str += '<div id="renderNext"><button id="uploadRender">Next</button></div>';
            document.getElementById("learning").innerHTML = str;
        }

        function uploadRender() {
            index = 0;
            str = "";
            Extantions = []; //only the end
            filesPath = []; //the all file path
            allPath = GP[levelNum - 1].File_path.split(",");
            for (var i = 0; i < (allPath.length - 1); i++) {
                path = allPath[i].split(".");
                for (var j = 0; j < path.length; j++) {
                    if (j % 2 != 0)
                        Extantions.push(path[j]);
                    else filesPath.push(path[j]);
                }
            }
            nextUpload();
        }


        function nextUpload() {
            str = "";
            if (index == (allPath.length - 1)) { //check if we have finished going through all the files
                str += '<p>Now you are required to take an exam.</br>A number of questions will appear on the exam.</br> When you click on the "Next" button you will start the exam and you will not be able to go back.</br>At the end of each question, click on the "Check" button and then "Next" to continue to the next question.</p>';
                str += '<div id="renderNext"><button id="createQuestion">Next</button></div>';
                $(".loginBox").css({ "height": "540px", "width": "850px", "top": "55%" });
            }
            else {
                if (Extantions[index] == "pdf" || Extantions[index] == "docx") {
                    str += '<embed class="uploadPDF" type="text/' + Extantions[index] + '" src="../' + filesPath[index] + '.' + Extantions[index] + '">';
                    $(".loginBox").css({ "height": "650px", "width": "950px", "top": "65%" });
                }
                else if (Extantions[index] == "png" || Extantions[index] == "jpg")
                    str += '<img class="uploadImage" src="../' + filesPath[index] + '.' + Extantions[index] + '" />';
                str += '<div id="renderNext"><button id="nextUpload">Next</button></div>';
                index++;
            }
            document.getElementById("learning").innerHTML = str;
        }


        function createQuestion() {
            counter = 0;
            Question = [];//array of all the questions
            Question.push(GP[levelNum - 1].Question_content_1, GP[levelNum - 1].Question_content_2, GP[levelNum - 1].Question_content_3, GP[levelNum - 1].Question_content_4);

            arrAnswers_1 = GP[levelNum - 1].Answers_1.split(",");//array for answers to question 1
            correct_answer1 = arrAnswers_1[0];//save correct answer for question 1
            arrAnswers_1 = arrAnswers_1.sort(() => Math.random() - 0.5);//shuffle the arr

            arrAnswers_2 = GP[levelNum - 1].Answers_2.split(",");//array for answers to question 2
            correct_answer2 = arrAnswers_2[0];//save correct answer for question 2
            arrAnswers_2 = arrAnswers_2.sort(() => Math.random() - 0.5);//shuffle the arr

            arrAnswers_3 = GP[levelNum - 1].Answers_3.split(",");//array for answers to question 3
            correct_answer3 = arrAnswers_3[0];//save correct answer for question 3
            arrAnswers_3 = arrAnswers_3.sort(() => Math.random() - 0.5);//shuffle the arr

            arrAnswers_4 = GP[levelNum - 1].Answers_4.split(",");//array for answers to question 4
            correct_answer4 = arrAnswers_4[0];//save correct answer for question 4
            arrAnswers_4 = arrAnswers_4.sort(() => Math.random() - 0.5);//shuffle the arr

            allAnswersArr = arrAnswers_1.concat(arrAnswers_2, arrAnswers_3, arrAnswers_4);//arr for all the answers.
            allCorrectAnswersArr = [];//arr for all the correct answers.
            allCorrectAnswersArr.push(correct_answer1, correct_answer2, correct_answer3, correct_answer4);
            for (var i = 0; i < allCorrectAnswersArr.length; i++) {
                if (allCorrectAnswersArr[i] != "-")
                    counter++; //Count how many questions there are at the level
            }
            indexAnswer = 0;
            indexQuestion = 0;
            endpoint = 4;
            startpoint = 0;
            renderQuestions()
        }

        function renderQuestions() {
            count = 0;//count the number of answer
            str = "";//render on a html the question and answers
            if (Question[indexQuestion] != "-" && indexAnswer != allCorrectAnswersArr.length) {
                str += "<p>Please select the <b>correct<b> answer</p>";
                str += "<p class='questionP'>" + Question[indexQuestion] + "</p>";
                for (j = startpoint; j < endpoint; j++) {
                    str += '<input type="radio" id="answer' + count + '" name="answer" value="' + allAnswersArr[j] + '"><label class="lableRadio" for="answer' + count + '">' + allAnswersArr[j] + '</label><br>';
                    count++;
                }
                str += '<button id="checkAnswer">Check</button><br>';
                str += '<div id="renderNext"><button id="nextAnswer" disabled>Next</button></div>';
                indexQuestion++;
                startpoint += 4;
                endpoint += 4;
                document.getElementById("learning").innerHTML = str;
            }
            else {
                MyPerforms = {
                    Volunteer_email: getDatails.Volunteer_email,
                    Level_serial_num: levelNum,
                    Score: score
                }
                ajaxCall("POST", "../api/PerformsPrograms", JSON.stringify(MyPerforms), postSuccessSave, postErrorSave);
                return false;
                
            }

        }

        function postSuccessSave() {
            score = 0;
            if (levelNum == GP.length) {
                let apiCall = "../api/PerformsPrograms/Read_scores?email=" + getDatails.Volunteer_email;
                ajaxCall("GET", apiCall, "", getSuccessScore, getErrorScore);
            }
            else performs();
        }

        function getSuccessScore(AllScores) {
            finalScore = 0;
            for (var i = 0; i < AllScores.length; i++) {
                finalScore += AllScores[i] * ((100 / AllScores.length)/100);
            }
            str = '';
            str += 'You have completed the program! Your final score is: ' + finalScore ;
            document.getElementById("alertMessage").innerHTML = str;
            performs();
        }

        function getErrorScore() {
            console.log("ErrorScore");
        }

        function postErrorSave() {
            console.log("failed in saving performs details");
        }

        function checkAnswer() {
            //check if the answer is correct
            let SelectedAnswer = $("input[type=radio][name=answer]:checked").val();//get the value from the checkbox
            if (indexAnswer != allCorrectAnswersArr.length) {
                if (SelectedAnswer == allCorrectAnswersArr[indexAnswer]) {//check if the answer is correct
                    alert("Good Job! The answer is correct")
                    score += (100 / counter);
                }
                else alert("Sorry, The answer is incorrect")
                indexAnswer++;
                score += 0;
                $("#nextAnswer").attr('disabled', false);
            }
        }

    </script>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <img class="logoFOA" src="../Images/FOA.png" />
            </div>
            <ul class="nav navbar-nav">
                <li><a class="space" href="VolunteerHome.html">Home</a></li>
                <li><a class="space" href="#">Tutorial</a></li>
                <li><a class="space" href="#">Activity time</a></li>
                <li><a class="space" href="Reports.html">Reports</a></li>
                <li><a class="space" href="#">Keywords</a></li>
                <li class="dropdown"></li>
            </ul>
        </div>
    </nav>
    <div class="loginBox">
        <div id="learning"></div>
        <div id="alertMessage"></div>
        <div id="QA"></div>
    </div>
</body>
</html>