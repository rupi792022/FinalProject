<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <link href="../css/GuidingProgram.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            getDatails = JSON.parse(localStorage.getItem('userDetails'));
            var user = $('<a class= "dropdown-toggle" data-toggle="dropdown" href="#">' + getDatails.First_name + ' ' + getDatails.Last_name + '<span class= "caret"></span></a><ul class="dropdown-menu"><li><a href="#">Personal details</a></li><li><a href="#">Log out</a></li></ul>');
            $(user).clone().appendTo(".dropdown");

            count = 1;
            NumOfLevel = 1;
            toUpdate = false;
            $(".stepDetails").hide();
            $("#edit").hide();
            $("#AddQuestion").click(AddQuestion);
            $("#next").attr('disabled', true);
            $("#save").click(Save);
            $("#next").click(Next);
            $("#back").click(Back);
            $('#buttonUpload').on('click', function () {
                var data = new FormData();
                var files = $("#files").get(0).files;

                // Add the uploaded file to the form data collection
                if (files.length > 0) {
                    for (f = 0; f < files.length; f++) {
                        data.append("UploadedImage", files[f]);
                    }
                    data.append("name", "FOAfiles"); // append what ever data you want to send along with the files. See how you extract it in the controller.
                }

                // Ajax upload
                $.ajax({
                    type: "POST",
                    url: "../Api/FileUpload",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: showImages,
                    error: error
                });

                return false;
            });

            $('#level_serial_num').change(function () {
                $(".stepDetails").show();
            });
        });



        function showImages(data) {
            console.log(data);

            var imgStr = "";

            if (Array.isArray(data)) {

                for (var i = 0; i < data.length; i++) {
                    imgStr += "<img src='../" + data[i] + "'/>";
                }
            }

            else {
                imgStr = "<img src='../" + data + "'/>";
            }

            document.getElementById("ph").innerHTML = imgStr;
        }

        function error(data) {
            console.log(data);
        }

        function AddQuestion() {
            count++;
            if (count < 5) {
                var addQuestion = $('<input type="text" id="question' + count + '" name="Question" required placeholder="Enter a question"><input type="text" id="' + count + '_correctAnswer1" name="correctAnswer1" required placeholder="Enter a correct Answer"><input type = "text" id ="' + count + '_Answer2" name = "Answer2" required placeholder = "Enter a possible answer"><input type="text" id="' + count + '_Answer3" name="Answer3" required placeholder="Enter a possible answer"><input type = "text" id ="' + count + '_Answer4" name = "Answer4" required placeholder = "Enter a possible answer"><br>');
                $(addQuestion).clone().appendTo("#AddNewQuestion");
            }
            else alert("You can only insert a 4 questions");
        }

        function Save() {
            let managerEmail = getDatails.Volunteer_email;
            let programName = $("#program_name").val();
            let levelSerialNum = NumOfLevel;
            let contentLevel = $("#contentLevel").val();
            let question1 = $("#question1").val();
            let question2 = $("#question2").val();
            let question3 = $("#question3").val();
            let question4 = $("#question4").val();
            let strAnswers_1 = $("#1_correctAnswer1").val().concat(",", $("#1_Answer2").val(), ",", $("#1_Answer3").val(), ",", $("#1_Answer4").val());
            let strAnswers_2 = $("#2_correctAnswer1").val().concat(",", $("#2_Answer2").val(), ",", $("#2_Answer3").val(), ",", $("#2_Answer4").val());
            let strAnswers_3 = $("#3_correctAnswer1").val().concat(",", $("#3_Answer2").val(), ",", $("#3_Answer3").val(), ",", $("#3_Answer4").val());
            let strAnswers_4 = $("#4_correctAnswer1").val().concat(",", $("#4_Answer2").val(), ",", $("#4_Answer3").val(), ",", $("#4_Answer4").val());
            //missing values

                MyGuidingProgram = {
                Manager_email: managerEmail,
                Program_name: programName,
                Level_serial_num: levelSerialNum,
                Date: "y",
                Content_level: contentLevel,
                Question_content_1: question1,
                Question_content_2: question2,
                Question_content_3: question3,
                Question_content_4: question4,
                Answers_1: strAnswers_1,
                Answers_2: strAnswers_2,
                Answers_3: strAnswers_3,
                Answers_4: strAnswers_4
            }

            if (toUpdate) {
                ajaxCall("PUT", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), PutSuccessSave, PutErrorSave)
            }
            ajaxCall("POST", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), SaveSuccessCB, SaveErrorCB);
            return false;
        }

        function PutSuccessSave() {
            console.log("success to upadte all the details");
        }
        function PutErrorSave(error) {
            console.log(error);
        }

        function SaveSuccessCB() {
            console.log("success to insert all the details");
            $('#next').removeAttr('disabled');
        }
        function SaveErrorCB(error) {
            console.log(error);
        }


        function Next() {
            NumOfLevel++;
            $("#edit").hide();
            //empty value
            $("#contentLevel").val('');
            $("#question1").val('');
            $("#question2").val('');
            $("#question3").val('');
            $("#question4").val('');

            $("#1_correctAnswer1").val('');
            $("#1_Answer2").val('');
            $("#1_Answer3").val('');
            $("#1_Answer4").val('');

            $("#2_correctAnswer1").val('');
            $("#2_Answer2").val('');
            $("#2_Answer3").val('');
            $("#2_Answer4").val('');

            $("#3_correctAnswer1").val('');
            $("#3_Answer2").val('');
            $("#3_Answer3").val('');
            $("#3_Answer4").val('');


            $("#4_correctAnswer1").val('');
            $("#4_Answer2").val('');
            $("#4_Answer3").val('');
            $("#4_Answer4").val('');

            let apiCall = "../api/GuidingPrograms/Read_GP?level_serial_num=" + NumOfLevel;
            ajaxCall("GET", apiCall, "", getSuccessNext, getErrorNext);

        }

        function getSuccessNext(DetailsOfLevel) {
            if (DetailsOfLevel != null) {//אם באותו השלב הערכים מלאים
                insertDetails(DetailsOfLevel);
            }
            else {
                $("#AddNewQuestion").remove();
            }
        }

        function getErrorNext() { }

        function Edit() {
            $(".stepDetails > input").attr("readonly", false);
        }

        function Back() {
            NumOfLevel--;
            let apiCall = "../api/GuidingPrograms/Read_GP?level_serial_num=" + NumOfLevel;
            ajaxCall("GET", apiCall, "", getSuccessBack, getErrorBack);
        }

        function getSuccessBack(DetailsOfLevel) {
            console.log(DetailsOfLevel);
            insertDetails(DetailsOfLevel);
        }
        function getErrorBack(error) {
            console.log(error);
        }

        function insertDetails(DetailsOfLevel) {
            toUpdate = true;
            $("#edit").show();
            $(".stepDetails > input").attr("readonly", true);
            $("#contentLevel").val(DetailsOfLevel.content_level);

            $("#question1").val(DetailsOfLevel.question_content_1);

            arrAnswers_1 = DetailsOfLevel.answers_1.split(",");
            $("#1_correctAnswer1").val(arrAnswers_1[0]);
            $("#1_Answer2").val(arrAnswers_1[1]);
            $("#1_Answer3").val(arrAnswers_1[2]);
            $("#1_Answer4").val(arrAnswers_1[3]);

            $("#question2").val(DetailsOfLevel.question_content_2);

            arrAnswers_2 = DetailsOfLevel.answers_2.split(",");
            $("#2_correctAnswer1").val(arrAnswers_2[0]);
            $("#2_Answer2").val(arrAnswers_2[1]);
            $("#2_Answer3").val(arrAnswers_2[2]);
            $("#2_Answer4").val(arrAnswers_2[3]);

            $("#question3").val(DetailsOfLevel.question_content_3);

            arrAnswers_3 = DetailsOfLevel.answers_3.split(",");
            $("#3_correctAnswer1").val(arrAnswers_3[0]);
            $("#3_Answer2").val(arrAnswers_3[1]);
            $("#3_Answer3").val(arrAnswers_3[2]);
            $("#3_Answer4").val(arrAnswers_3[3]);

            arrAnswers_4 = DetailsOfLevel.answers_4.split(",");
            $("#4_correctAnswer1").val(arrAnswers_4[0]);
            $("#4_Answer2").val(arrAnswers_4[1]);
            $("#4_Answer3").val(arrAnswers_4[2]);
            $("#4_Answer4").val(arrAnswers_4[3]);
        }


    </script>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <img src="../Images/FOA.png" />
            </div>
            <ul class="nav navbar-nav">
                <li><a class="space" href="ManagerHome.html">Home</a></li>
                <li><a class="space" href="DefiningLearningPath.html">Learning guidance</a></li>
                <li><a class="space" href="#">Activity time</a></li>
                <li><a class="space" href="#">Reports</a></li>
                <li><a class="space" href="#">Deshbord</a></li>
                <li><a class="space" href="#">Keywords</a></li>
                <li class="dropdown"></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <input type="text" id="program_name" name="program_name" required placeholder="Enter the name of the learning path">
        <input type="number" id="level_serial_num" name="level_serial_num" required placeholder="Enter Steps Number" min="1">

        <div class="stepDetails">
            <input type="text" id="contentLevel" name="contentLevel" required placeholder="Enter a content">
            <form method="post" enctype="multipart/form-data" id="formUpload">
                <div>
                    <label for="files">Files</label>
                    <input type="file" id="files" name="files" multiple="multiple" />
                </div>
                <br />
                <button type="button" id="buttonUpload">Upload files</button><br>
            </form>
            <div id="ph"></div>
            <button type="button" id="AddQuestion">Add Question</button><br>
            <div>
                <input type="text" id="question1" name="Question" required placeholder="Enter a question">
                <input type="text" id="1_correctAnswer1" name="correctAnswer1" required placeholder="Enter a correct Answer">
                <input type="text" id="1_Answer2" name="Answer2" required placeholder="Enter a possible answer">
                <input type="text" id="1_Answer3" name="Answer3" required placeholder="Enter a possible answer">
                <input type="text" id="1_Answer4" name="Answer4" required placeholder="Enter a possible answer"><br>
                <div id="AddNewQuestion"></div>
            </div>
            <button type="button" id="back">Back</button><br>
            <button type="button" id="next">Next</button><br>
            <button type="button" id="save">Save</button><br>
            <button type="button" id="edit">Edit</button><br>
        </div>
    </div>
</body>
</html>