<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <link href="../css/GuidingProgram.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            getDatails = JSON.parse(localStorage.getItem('managerDetails'));
            var user = $('<a class= "dropdown-toggle" data-toggle="dropdown" href="#">' + getDatails.First_name + ' ' + getDatails.Last_name + '<span class= "caret"></span></a><ul class="dropdown-menu"><li><a href="SingIn.html">Add volunteer</a></li><li><a href="#">Personal details</a></li><li><a onclick="logOut()">Log out</a></li></ul>');
            $(user).clone().appendTo(".dropdown");

            NumOfAnswers = 4;
            count = 1;
            clickUpload = 0;

            $("#remove").hide();
            $("#save").click(Save);


            $('#buttonUpload').on('click', function () { //uploaded file
                clickUpload++;
                var data = new FormData();
                var files = $("#files").get(0).files;

                // Add the uploaded file to the form data collection
                if (files.length > 0) {
                    for (f = 0; f < files.length; f++) {
                        data.append("uploadedFiles", files[f]);
                    }
                    data.append("name", "FOAfiles"); // append what ever data you want to send along with the files. See how you extract it in the controller.
                }

                if (clickUpload == 1) {
                    $(".loginBox").css({ "height": "+=55", "top": "+=5%"});
                }

                // Ajax upload
                $.ajax({
                    type: "POST",
                    url: "../Api/FileUpload",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: showImages,
                    error: error
                });

                return false;
            });
        });

        function logOut() {
            localStorage.clear();
            window.location.href = "LogIn.html";
        }

        function showImages(data) {
            console.log(data);
            filePath = "";
            var imgStr = "";

            if (Array.isArray(data)) {

                for (var i = 0; i < data.length; i++) {
                    imgStr += "<img src='../" + data[i] + "'/>";
                    filePath += data[i];
                    filePath += ","
                }
            }

            else {
                imgStr = "<img src='../" + data + "'/>";
            }
            document.getElementById("ph").innerHTML = imgStr;
        }

        function error(data) {
            console.log(data);
        }

        function AddNewProgram() {
            $("#defineTheProgram").show(); //Name of Program and Number of level div
            $("#btnChoose").hide(); // add/edit btn div
            let apiCall = "../api/GuidingPrograms/Read_Max_Program";
            ajaxCall("GET", apiCall, "", getSuccessMaxProgram, getErrorMaxProgram);
        }

        function getSuccessMaxProgram(maxProgram) {
            numOfprogram = maxProgram++;
        }

        function getErrorMaxProgram() {
            console.log("Error");
        }
       
        //function title(level) {
        //    strTitle = "";
        //    strTitle += "<h1>Level Number " + level + "</h1>";
        //    document.getElementById("title").innerHTML = strTitle;
        //}

        function AddQuestion() {
           count ++;
           str = "";
                str += '<tr><td><p>Question ' + count + ':</p></td>';
                str += '<td><input type="text" id="question' + count + '" name="Question" required placeholder="Enter a question"></td>';
                for (var i = 1; i < NumOfAnswers; i++) {
                    if (i == 1) {
                        str += '<td><p>' + i + '.</p></td><td class="correctAnswer"><input type="text"  id="' + count + '_correctAnswer' + i + '" name="correctAnswer"' + i + '"required placeholder="Enter a correct Answer"></td></tr>';
                    }
                    str += '<tr><td></td><td></td><td><p>' + (i + 1) + '.</p><td><input type="text" id="' + count + '_Answer' + (i + 1) + '"name="Answer"' + (i + 1) + '"required placeholder="Enter a possible answer"></td>';
                }
                str += '</tr>';
                $(str).clone().appendTo("#renderQA");

                $(".loginBox").css({ "height": "+=160", "top": "+=14%" });
                $("#remove").show();
        }

        function Remove() {//remove question
            var table = document.getElementById("renderQA");
            var rowCount = table.rows.length;
            for (let i = 1; i < 5; i++) {
                table.deleteRow(rowCount - i);
            }
            count--;
            $(".loginBox").css({ "height": "-=160", "top": "-=14%" });
            if (count == 1)
                $("#remove").hide();
        }


        function Save() {
            programName = $("#program_name").val();
            contentguiding = $("#contentguiding").val();
            question1 = $("#question" + count).val();
            questions = [];
            answers = [];
            for (var i = 0; i < count; i++) {
                questions[i] = $("#question" + (i + 1)).val();
                concatAllanswers = $("#" + (i + 1) + "_correctAnswer" + (i + 1)).val()
                for (var k = 1; k < NumOfAnswers; k++) {
                    concatAllanswers.concat(",", $("#" + (i + 1) + "_Answer" + (k + 1)).val());
                }
                answers[i] = concatAllanswers;
            }

            MyGuidingProgram = {
                Program_name: programName,
                Level_serial_num: countLevel,
                File_path: filePath,
                Content_level: contentLevel,
                Question_content_1: question1,
                Question_content_2: question2,
                Question_content_3: question3,
                Question_content_4: question4,
                Answers_1: strAnswers_1,
                Answers_2: strAnswers_2,
                Answers_3: strAnswers_3,
                Answers_4: strAnswers_4
            }

            if (toUpdate) {
                ajaxCall("PUT", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), putSuccessSave, putErrorSave)
            }
            else
                ajaxCall("POST", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), postSuccessSave, postErrorSave);
            return false;
        }
               
           
        }


        function putObject(managerEmail, programName, contentLevel, question1, question2, question3, question4, strAnswers_1, strAnswers_2, strAnswers_3, strAnswers_4) {

            if (contentLevel == "" || question1 == "") {
                strAnswers_1 = "-";
                str = '';
                str += '*You must enter content level, uploaded files and question 1';
                document.getElementById("alertMessage2").innerHTML = str;
            }

            else {
                str = '';
                document.getElementById("alertMessage2").innerHTML = str;
                MyGuidingProgram = {
                    Manager_email: managerEmail,
                    Program_name: programName,
                    Level_serial_num: countLevel,
                    File_path: filePath,
                    Content_level: contentLevel,
                    Question_content_1: question1,
                    Question_content_2: question2,
                    Question_content_3: question3,
                    Question_content_4: question4,
                    Answers_1: strAnswers_1,
                    Answers_2: strAnswers_2,
                    Answers_3: strAnswers_3,
                    Answers_4: strAnswers_4
                }

                if (toUpdate) {
                    ajaxCall("PUT", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), putSuccessSave, putErrorSave)
                }
                else
                    ajaxCall("POST", "../api/GuidingPrograms", JSON.stringify(MyGuidingProgram), postSuccessSave, postErrorSave);
                return false;
            }
        }


        function putSuccessSave() {
            console.log("success to upadte all the details");
            alert("The level was successfully saved");
            $('#next').removeAttr('disabled');
        }

        function putErrorSave(error) {
            console.log(error);
        }

        function postSuccessSave() {
            console.log("success to insert all the details");
            alert("The level was successfully saved");
            $('#next').removeAttr('disabled');
        }

        function postErrorSave(error) {
            console.log(error);
        }


        function Next() {
            NumOfLevel++;
            countLevel++;
            if (NumOfLevel <= LevelsAmount) { //The number of levels in the program
                let apiCall = "../api/GuidingPrograms/Read_Level?level_num=" + NumOfLevel;
                ajaxCall("GET", apiCall, "", getSuccessNext, getErrorNext);
                $("#back").show();
                $("#back").attr('disabled', false);
                $("#remove").hide();
            }
            else {
                alert("You have reached the maximum amount of levels. Click finish if you share");
            }
            if (NumOfLevel == LevelsAmount) { //When we reach the final level the next button changes to finishProgram
                $("#finishProgram").show();
                $("#next").hide();
            }
        }

        function getSuccessNext(DetailsOfLevel) {
            clickUpload = 0;
            $(".loginBox").css({ "height": "650px", "width": "1000px", "top": "65%" });
            title(NumOfLevel);
            if (DetailsOfLevel.Content_level != null) {//check if is the values are full in the level
                insertDetails(DetailsOfLevel);
            }
            else {
                str = "";
                document.getElementById("renderQA").innerHTML = str;
                document.getElementById("ph").innerHTML = str;
                $("#files").val('');
                $("#contentLevel").val('');
                $("#question1").val('');
                $("#1_correctAnswer1").val('');
                $("#1_Answer2").val('');
                $("#1_Answer3").val('');
                $("#1_Answer4").val('');
                count = 1;
            }
        }

        function insertDetails(DetailsOfLevel) { 
            $(".loginBox").css({ "height": "+=20" });
            toUpdate = true;
            str = "";
            document.getElementById("renderQA").innerHTML = str;
            strFile = "You must upload the relevant files for this step again.";
            document.getElementById("alertMessageFile").innerHTML = strFile;
            $("#contentLevel").val(DetailsOfLevel.Content_level);
            $("#question1").val(DetailsOfLevel.Question_content_1);
            var Question = [];//array of all the questions
            Question.push(DetailsOfLevel.Question_content_2, DetailsOfLevel.Question_content_3, DetailsOfLevel.Question_content_4);
            arrAnswers_1 = DetailsOfLevel.Answers_1.split(","); 
            $("#1_correctAnswer1").val(arrAnswers_1[0]);
            $("#1_Answer2").val(arrAnswers_1[1]);
            $("#1_Answer3").val(arrAnswers_1[2]);
            $("#1_Answer4").val(arrAnswers_1[3]);
            arrAnswers_2 = DetailsOfLevel.Answers_2.split(",");
            arrAnswers_3 = DetailsOfLevel.Answers_3.split(",");
            arrAnswers_4 = DetailsOfLevel.Answers_4.split(",");
            allAnswersArr = arrAnswers_2.concat(arrAnswers_3, arrAnswers_4);

            renderLevelDetails(Question, allAnswersArr); 
        }

        function renderLevelDetails(Question, allAnswersArr) {
            answers = 0;
            howMach = 1; //for AddQuestion if we update
            NumOfAnswer = 1;
            str = "";
            for (var i = 0; i < Question.length; i++) {
                if (Question[i] != "-") {
                    howMach++;
                    str += '<tr><td><p>Question ' + (i + 2) + ':</p></td>';
                    str += '<td><input type="text" id="question' + (i + 2) + '" name="Question" value="' + Question[i] + '"></td>';
                    NumOfAnswer = 1;
                    for (var k = answers; k < (4 + answers); k++) {
                        if ((k % 4) == 0) {
                            str += '<td><p>' + NumOfAnswer + '.</p></td><td class="correctAnswer"><input type="text" id="' + (i + 2) + '_correctAnswer1" name="correctAnswer1" value="' + allAnswersArr[k] + '"></td></tr>';
                        }
                        else {
                            str += '<tr><td></td><td></td><td><p>' + NumOfAnswer + '.</p></td><td><input type="text" id="' + (i + 2) + '_Answer' + NumOfAnswer + '" name="Answer"' + NumOfAnswer + '" value="' + allAnswersArr[k] + '"></td></tr>';
                        }
                        NumOfAnswer++;
                    }
                    answers += 4;
                    $(".loginBox").css({ "height": "+=160", "top": "+=14%" });
                }
                document.getElementById("renderQA").innerHTML = str;
            }
            if (howMach == 1) {
                count = 1;
            }
            else
                count = howMach;
        }

        function getErrorNext() {
            console.log("Error moving to next step");
        }

        function Back() {
            NumOfLevel--;
            countLevel--;
            $("#back").attr('disabled', false);
            let apiCall = "../api/GuidingPrograms/Read_Level?level_num=" + NumOfLevel;
            ajaxCall("GET", apiCall, "", getSuccessBack, getErrorBack);
            $("#remove").hide();

            if (NumOfLevel == 1) {
                $("#back").attr('disabled', true);
            }
        }

        function getSuccessBack(DetailsOfLevel) {
            clickUpload = 0;
            $(".loginBox").css({ "height": "650px", "width": "1000px", "top": "65%" });
            console.log(DetailsOfLevel);
            title(NumOfLevel);
            insertDetails(DetailsOfLevel);
            $("#next").show();
            $("#finishProgram").hide();
        }

        function getErrorBack(error) {
            console.log(error);
        }

        function EditProgram() {
            toUpdate = true;
            $("#btnChoose").hide();
            NumOfLevel = 1;
            let apiCall = "../api/GuidingPrograms/Read_Level?level_num=" + NumOfLevel;
            ajaxCall("GET", apiCall, "", getSuccessEP, getErrorEP);
        }

        function getSuccessEP(DetailsOfLevel) {
            $("#stepDetails").show();
            title(NumOfLevel);
            insertDetails(DetailsOfLevel);

            let apiCall = "../api/GuidingPrograms/Read_maxLevel";
            ajaxCall("GET", apiCall, "", getSuccessMaxLevel, getErrorMaxLevel);
        }

        function getSuccessMaxLevel(maxLevel) {
            LevelsAmount = maxLevel; //LevelsAmount is The number of levels in the program
        }

        function getErrorMaxLevel() {
            console.log(error);
        }

        function getErrorEP(error) {
            console.log(error);
        }

        function FinishProgram() {
            window.location.href = "GuidingProgram.html";
        }

    </script>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <img src="../Images/FOA.png" />
            </div>
            <ul class="nav navbar-nav">
                <li><a class="space" href="ManagerHome.html">Home</a></li>
                <li><a class="space" href="DefiningLearningPath.html">Guiding Program</a></li>
                <li><a class="space" href="#">Activity time</a></li>
                <li><a class="space" href="#">Reports</a></li>
                <li><a class="space" href="#">Deshbord</a></li>
                <li><a class="space" href="#">Keywords</a></li>
                <li class="dropdown"></li>
            </ul>
        </div>
    </nav>
    <div class="loginBox">
        <div id="btnChoose">
            <button type="button" id="editProgram">Edit Program</button>&nbsp;&nbsp;&nbsp;&nbsp;
            <button type="button" id="addNewProgram">Add New Program</button>
        </div>
        <div id="title"></div><br>
        <div id="defineTheProgram">
            <table>
                <tr>
                    <td><p>Name of Program:</p></td>
                    <td> <input type="text" id="program_name" name="program_name" placeholder="Name of the program" /></td>
                    <td class="rightSide"><button type="submit" id="buttonStart">Start</button><br></td>
                </tr>
            </table>
            <label id="alertMessage1"></label>
        </div>
        <div id="stepDetails">
            <textarea id="contentguiding" name="contentguiding" cols="50" rows="8" placeholder="Enter a content"></textarea>
            <div id="alertMessageFile"></div>
            <form method="post" enctype="multipart/form-data" id="formUpload">
                <div>
                    <label for="files">Please select file - you can choose more than one.</label>
                    <input type="file" id="files" name="files" multiple="multiple" />
                </div>
                <br />
                <button type="button" id="buttonUpload">Upload files</button><br>
            </form>
            <div id="ph"></div>
            <br><button type="button" id="AddQuestion">Add Question</button><br>
            <table id="AddNewQuestion">
                <tr>
                    <td><p>Question 1:</p></td>
                    <td><input type="text" id="question1" name="Question" placeholder="Enter a question" /></td>
                    <td><p>1.</p></td>
                    <td class="correctAnswer"><input type="text" id="1_correctAnswer1" name="correctAnswer1" placeholder="Enter a correct Answer" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td><p>2.</p></td>
                    <td> <input type="text" id="1_Answer2" name="Answer2" placeholder="Enter a possible answer" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td><p>3.</p></td>
                    <td><input type="text" id="1_Answer3" name="Answer3" placeholder="Enter a possible answer" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td><p>4.</p></td>
                    <td><input type="text" id="1_Answer4" name="Answer4" placeholder="Enter a possible answer" /></td>
                </tr>
            </table><br>
            <table id="renderQA"></table>
            <table id="btn">
                <tr>
                    <td><button type="button" id="remove">Remove question</button><br></td>
                    <td></td>
                    <td colspan="2"><label id="alertMessage2"></label></td>
                </tr>
                <tr>
                    <td><button type="button" id="back">Back</button></td>
                    <td></td>
                    <td></td>
                    <td><button type="button" id="save">Save</button>&nbsp;&nbsp;<button type="button" id="next">Next</button><button type="button" id="finishProgram">Finish Program</button></td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>